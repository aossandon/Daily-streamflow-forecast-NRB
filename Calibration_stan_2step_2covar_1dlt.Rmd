---
title: "Calibration_stan_2step_2covar_1dlt"
author: "Alvaro Ossandon"
date: "01/03/2022"
output:
  html_document:
    fig_caption: yes
    toc: yes
---

- considering covariates from the previous day
- Period: 1979-2013
- Log transformation was applied to Q for GEV fitting

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
#### CLEAR MEMORY
rm(list=ls())
#### Prevent Warnings
options(warn=-1)
#### Clear the R console
cat("\f")
```

# Read data

```{r read_data}
LeadT=1#enter the lead time
cov1=paste("best_mod_",LeadT,"LT",sep="")
lag_days=30:21
time_elapsed=0
ptm1 = proc.time()
mainDir=getwd()
knitr::opts_knit$set(root.dir = mainDir)
setwd(mainDir)
suppressPackageStartupMessages(source("library.R"))
source("library.R")
load_packages(c("parallel","rstan","ggplot2","rlist","knitr","loo"),quietly=TRUE)
name_dir="Results"
dir_create("Results")
dir_r=paste(mainDir,"Results",sep = "/")
dir_create("Results/Parameters")
dir_data_r=paste(mainDir,"Results/Parameters",sep = "/")
dir_create(paste("Results/",1,"LT",sep = ""))
dir_JPG=paste(dir_r,"/",1,"LT",sep = "")



setwd(mainDir)
data=list.load('Data_VIC_Forecasted_Flow_Diff_LeadTimes_2003_2018.rds')
data1=list.load('Data_P_Obs_Diff_LeadTimes_2003_2018.rds')
data_v=list.load('Data_VIC_Simulated_Flow_2003_2018.rds')


```


```{r}
data_v=data_v[data_v$Year>=min(data$Q$Year) & data_v$Year<=max(data$Q$Year) & ((data_v$MONTH==6 & data_v$DAY>=lag_days[LeadT]) | data_v$MONTH==7 | (data_v$MONTH==8 & data_v$DAY<(lag_days[LeadT]+1))),]

```




```{r}
datath=cbind(data$VIC_1d[,4],data$VIC_1d[,5],data$VIC_1d[,6],data$VIC_1d[,7],data$VIC_1d[,8])
#get index with missing values
ind_o=which(is.na(data$Q$Garudeshwar)==F & is.na(data$Q$Mandleshwar)==F & is.na(data$Q$Handia)==F & is.na(data$Q$Hoshangabad)==F & is.na(data$Q$Sandiya)==F)
datQ=data$Q[ind_o,]
datath1=datath[ind_o,]
if (LeadT==1){
  covP=as.matrix(cbind(data_v[ind_o,5:6],data1$P_1d_1d_lt[ind_o,6],data_v[ind_o,8:9]))
  covPs=as.matrix(cbind(data_v[,5:6],data1$P_1d_1d_lt[,6],data_v[,8:9]))
}else{
  covP=as.matrix(data_v[ind_o,5:9])
  covPs=as.matrix(data_v[,5:9])
}

```


```{r run_stan}

thrQ=apply(datath, 2, function(x){quantile(x,p=0.8,na.rm=T)})

# sampler iterations
iterations = 500
warmup = 300
rng_seed = 1111
#setup data
#get index with missing values
ind_o=which(is.na(data$Q$Garudeshwar)==F & is.na(data$Q$Mandleshwar)==F & is.na(data$Q$Handia)==F & is.na(data$Q$Hoshangabad)==F & is.na(data$Q$Sandiya)==F)
No=length(ind_o)
stan_data = list(N=nrow(data$Q),No=No,S=5,ind_o=ind_o,y=as.matrix(data$Q[ind_o,4:8]),covQ=as.matrix(datath[ind_o,]),covP=as.matrix(data_v[ind_o,5:9]),covQs=as.matrix(datath),covPs=as.matrix(data_v[,5:9]),thrQ=thrQ,indc=1:5)

#get the element for each step
nam=c("g","m","h","ho","s")
for (i in 1:5) {
  if (LeadT==1 & i==3 & length(which(stan_data$covP[,i]==0))>0){
    stan_data[[paste("ind_",nam[i],1,sep="")]]=which(stan_data$covP[,i]==0)
    stan_data[[paste("N_",nam[i],1,sep="")]]=length(stan_data[[paste("ind_",nam[i],1,sep="")]])
    stan_data[[paste("ind_",nam[i],2,sep="")]]=which(stan_data$covP[,i]>0 & stan_data$covQ[,i]<=stan_data$thrQ[i])
    stan_data[[paste("N_",nam[i],2,sep="")]]=length(stan_data[[paste("ind_",nam[i],2,sep="")]])
    stan_data[[paste("ind_",nam[i],3,sep="")]]=which(stan_data$covP[,i]>0 & stan_data$covQ[,i]>stan_data$thrQ[i])
    stan_data[[paste("N_",nam[i],3,sep="")]]=length(stan_data[[paste("ind_",nam[i],3,sep="")]])
    
    stan_data[[paste("indp_",nam[i],1,sep="")]]=which(stan_data$covPs[,i]==0)
    stan_data[[paste("Np_",nam[i],1,sep="")]]=length(stan_data[[paste("indp_",nam[i],1,sep="")]])
    stan_data[[paste("indp_",nam[i],2,sep="")]]=which(stan_data$covPs[,i]>0 & stan_data$covQs[,i]<=stan_data$thrQ[i])
    stan_data[[paste("Np_",nam[i],2,sep="")]]=length(stan_data[[paste("indp_",nam[i],2,sep="")]])
    stan_data[[paste("indp_",nam[i],3,sep="")]]=which(stan_data$covPs[,i]>0 & stan_data$covQs[,i]>stan_data$thrQ[i])
    stan_data[[paste("Np_",nam[i],3,sep="")]]=length(stan_data[[paste("indp_",nam[i],3,sep="")]])
    
  }else{
    stan_data[[paste("ind_",nam[i],1,sep="")]]=which(stan_data$covQ[,i]<=stan_data$thrQ[i])
    stan_data[[paste("N_",nam[i],1,sep="")]]=length(stan_data[[paste("ind_",nam[i],1,sep="")]])
    stan_data[[paste("ind_",nam[i],2,sep="")]]=which(stan_data$covQ[,i]>stan_data$thrQ[i])
    stan_data[[paste("N_",nam[i],2,sep="")]]=length(stan_data[[paste("ind_",nam[i],2,sep="")]])
    
    stan_data[[paste("indp_",nam[i],1,sep="")]]=which(stan_data$covQs[,i]<=stan_data$thrQ[i])
    stan_data[[paste("Np_",nam[i],1,sep="")]]=length(stan_data[[paste("indp_",nam[i],1,sep="")]])
    stan_data[[paste("indp_",nam[i],2,sep="")]]=which(stan_data$covQs[,i]>stan_data$thrQ[i])
    stan_data[[paste("Np_",nam[i],2,sep="")]]=length(stan_data[[paste("indp_",nam[i],2,sep="")]])
  }
  
  
}



```





#run the stan model

```{r}
# setwd(dir_data_r)
# stanfit=list.load("bayesian_model_gamma.rds")
# Simul=rstan::extract(stanfit)
```

```{r}
nchain=3
thin1=(iterations-warmup)/1000
if (thin1<=1){thin1=1}
time_elapsed=0
ptm = proc.time()
setwd(mainDir)
model_file = paste("bayesian_model_gamma_2step_diff_st_2_best_",LeadT,"dlt.stan",sep="")
stan_model = stan(model_file, data = stan_data, chains = 0)
# ,max_treedepth=14
stanfit = stan(fit = stan_model, data = stan_data,
                chains =nchain, iter=iterations,
                seed=rng_seed, warmup = warmup,thin=thin1,control=list(adapt_delta=0.99,max_treedepth=12),cores=nchain)
Simul=rstan::extract(stanfit)
sprintf("elapsed time: %s minutes",round((proc.time() - ptm)[3]/60,2))


#Just save the useful information
mod=list(ypost=Simul$y_rep,thrQ=stan_data$thrQ)
mod$beta_Gar=Simul$mu_garud
mod$phi_Gar=Simul$sigma_garud
mod$beta_Man=Simul$mu_mand
mod$beta_Han=Simul$mu_han
mod$beta_Hos=Simul$mu_hos
mod$beta_San=Simul$mu_san
mod$phi_Man=Simul$sigma_mand
mod$phi_Han=Simul$sigma_han
mod$phi_Hos=Simul$sigma_hos
mod$phi_San=Simul$sigma_san

setwd(dir_data_r)
list.save(mod, paste("Par_bayesian_model_gamma_",cov1,".rds",sep=""))

```









```{r}
print(stanfit, pars = c("mu_garud","sigma_garud","mu_mand","sigma_mand","mu_han","sigma_han","mu_hos","sigma_hos","mu_san","sigma_san"), probs=c(.025,.5,.975))

sampler_params <- get_sampler_params(stanfit, inc_warmup = TRUE)
summary(do.call(rbind, sampler_params), digits = 2)
```


##the loo package to carry out Pareto smoothed importance-sampling leave-one-out cross-validation (PSIS-LOO) for purposes of model checking

```{r}
loo1=loo(stanfit, save_psis = TRUE)
setwd(dir_JPG)
val1=rbind(loo1$estimates,c(max(summary(stanfit)$summary[,10]),min(summary(stanfit)$summary[,10])))
rownames(val1)=c(rownames(loo1$estimates),"rhat")
colnames(val1)=colnames(loo1$estimates)
write.table(loo1$estimates, file = "loo_summary.txt",sep="\t")
loo1
print(round(val1,4))
plot(loo1)
p1.base <- recordPlot()
invisible(dev.off())

jpeg("loo_plot.jpg", width =6, height = 4, units = 'in', res = 300)
p1.base
dev.off()
p1.base
```

#check that coefficients are significant

```{r}
#percent of samples below zero
nam=c("garud","mand","han","hos","san")

val=list(des="")
N=dim(Simul$mu_mand)[2]
nsim=dim(Simul$mu_mand)[1]
nam1=c()
sig=c()
for (i in 1:length(nam)) {
  tmp=Simul[[paste("mu_",nam[i],sep="")]]
  tmp_1=Simul[[paste("sigma_",nam[i],sep="")]]
  val[[paste("mu_",nam[i],sep="")]]=apply(tmp,2,function(x){length(which(x>0))/nsim*100})
  val[[paste("sigma_",nam[i],sep="")]]=apply(tmp_1,2,function(x){length(which(x>0))/nsim*100})
  nam1=c(nam1,paste("mu_",nam[i],sep=""),paste("sigma_",nam[i],sep=""))
  if (i==1){
    sig=c(sig,val[[paste("mu_",nam[i],sep="")]]>95,val[[paste("mu_",nam[i],sep="")]])
    sig=rbind(sig,c(val[[paste("sigma_",nam[i],sep="")]]>95,val[[paste("sigma_",nam[i],sep="")]]))
  }else{
    sig=rbind(sig,c(val[[paste("mu_",nam[i],sep="")]]>95,val[[paste("mu_",nam[i],sep="")]]))
    sig=rbind(sig,c(val[[paste("sigma_",nam[i],sep="")]]>95,val[[paste("sigma_",nam[i],sep="")]]))
  }

}
rownames(sig)=nam1
colnames(sig)=c(rep("Is it significant?",N),rep(">0",N))
print(sig)
```


# traceplots and pairs plots for each station


**Garudeshwar**

```{r, fig.height=8, fig.width=9}
# detach("package:coda", unload=TRUE)
i=1:6
traceplot(stanfit, pars = c(paste("mu_garud","[",i,"]",sep=""),"lp__"), inc_warmup = T, nrow = 3)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("traceplot_mu_garud.jpg", width =7, height = 6, units = 'in', res = 300)
p1.base
dev.off()
p1.base

```


```{r, fig.height=8, fig.width=9}
traceplot(stanfit, pars = c(paste("sigma_garud","[",i,"]",sep=""),"lp__"), inc_warmup = T, nrow = 3)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("traceplot_sigma_garud.jpg", width =7, height = 6, units = 'in', res = 300)
p1.base
dev.off()
p1.base

```


```{r, fig.height=8, fig.width=8}
pairs(stanfit,  pars = paste("mu_garud","[",i,"]",sep=""), las = 1)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("pairs_mu_garud.jpg", width =8, height = 8, units = 'in', res = 300)
p1.base
dev.off()
p1.base




```


```{r, fig.height=8, fig.width=8}
pairs(stanfit,  pars = paste("sigma_garud","[",i,"]",sep=""), las = 1)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("pairs_sigma_garud.jpg",width =8, height = 8, units = 'in', res = 300)
p1.base
dev.off()
p1.base




```

**Mandleshwar**

```{r, fig.height=8, fig.width=9}
# detach("package:coda", unload=TRUE)

traceplot(stanfit, pars = c(paste("mu_garud","[",i,"]",sep=""),"lp__"), inc_warmup = T, nrow = 3)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("traceplot_mu_garud.jpg", width =7, height = 6, units = 'in', res = 300)
p1.base
dev.off()
p1.base

```


```{r, fig.height=8, fig.width=9}
traceplot(stanfit, pars = c(paste("sigma_mand","[",i,"]",sep=""),"lp__"), inc_warmup = T, nrow = 3)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("traceplot_sigma_mand.jpg", width =7, height = 6, units = 'in', res = 300)
p1.base
dev.off()
p1.base

```


```{r, fig.height=8, fig.width=8}
pairs(stanfit,  pars = paste("mu_mand","[",i,"]",sep=""), las = 1)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("pairs_mu_mand.jpg", width =8, height = 8, units = 'in', res = 300)
p1.base
dev.off()
p1.base




```


```{r, fig.height=8, fig.width=8}
pairs(stanfit,  pars = paste("sigma_mand","[",i,"]",sep=""), las = 1)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("pairs_sigma_mand.jpg",width =8, height = 8, units = 'in', res = 300)
p1.base
dev.off()
p1.base




```


**Handia**

```{r, fig.height=8, fig.width=9}
traceplot(stanfit, pars = c(paste("mu_han","[",i,"]",sep=""),"lp__"), inc_warmup = T, nrow = 3)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("traceplot_mu_han.jpg", width =7, height = 6, units = 'in', res = 300)
p1.base
dev.off()
p1.base

```


```{r, fig.height=8, fig.width=9}
traceplot(stanfit, pars = c(paste("sigma_han","[",i,"]",sep=""),"lp__"), inc_warmup = T, nrow = 3)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("traceplot_sigma_han.jpg", width =7, height = 6, units = 'in', res = 300)
p1.base
dev.off()
p1.base

```


```{r, fig.height=8, fig.width=8}
pairs(stanfit,  pars = paste("mu_han","[",i,"]",sep=""), las = 1)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("pairs_mu_han.jpg", width =8, height = 8, units = 'in', res = 300)
p1.base
dev.off()
p1.base




```


```{r, fig.height=8, fig.width=8}
pairs(stanfit,  pars = paste("sigma_han","[",i,"]",sep=""), las = 1)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("pairs_sigma_han.jpg", width =8, height = 8, units = 'in', res = 300)
p1.base
dev.off()
p1.base




```


**Hoshangabad**

```{r, fig.height=8, fig.width=9}
traceplot(stanfit, pars = c(paste("mu_hos","[",i,"]",sep=""),"lp__"), inc_warmup = T, nrow = 3)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("traceplot_mu_hos.jpg", width =7, height = 6, units = 'in', res = 300)
p1.base
dev.off()
p1.base

```


```{r, fig.height=8, fig.width=9}
traceplot(stanfit, pars = c(paste("sigma_hos","[",i,"]",sep=""),"lp__"), inc_warmup = T, nrow = 3)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("traceplot_sigma_hos.jpg", width =7, height = 6, units = 'in', res = 300)
p1.base
dev.off()
p1.base

```


```{r, fig.height=8, fig.width=8}
pairs(stanfit,  pars = paste("mu_hos","[",i,"]",sep=""), las = 1)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("pairs_mu_hos.jpg", width =8, height = 8, units = 'in', res = 300)
p1.base
dev.off()
p1.base




```


```{r, fig.height=8, fig.width=8}
pairs(stanfit,  pars = paste("sigma_hos","[",i,"]",sep=""), las = 1)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("pairs_sigma_hos.jpg", width =8, height = 8, units = 'in', res = 300)
p1.base
dev.off()
p1.base




```


**Sandiya**

```{r, fig.height=6, fig.width=7}
traceplot(stanfit, pars = c(paste("mu_san","[",i,"]",sep=""),"lp__"), inc_warmup = T, nrow = 3)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("traceplot_mu_san.jpg", width =7, height = 6, units = 'in', res = 300)
p1.base
dev.off()
p1.base

```


```{r, fig.height=6, fig.width=7}
traceplot(stanfit, pars = c(paste("sigma_san","[",i,"]",sep=""),"lp__"), inc_warmup = T, nrow = 3)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("traceplot_sigma_san.jpg", width =7, height = 6, units = 'in', res = 300)
p1.base
dev.off()
p1.base

```


```{r, fig.height=6, fig.width=6}
pairs(stanfit,  pars = paste("mu_san","[",i,"]",sep=""), las = 1)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("pairs_mu_san.jpg", width =8, height = 8, units = 'in', res = 300)
p1.base
dev.off()
p1.base




```


```{r, fig.height=6, fig.width=6}
pairs(stanfit,  pars = paste("sigma_san","[",i,"]",sep=""), las = 1)
p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg("pairs_sigma_san.jpg", width =8, height = 8, units = 'in', res = 300)
p1.base
dev.off()
p1.base




```











## time series plots

```{r}
rm(stanfit)
datavic=data[[paste("VIC_",LeadT,"d",sep="")]]
data=data$Q


```


```{r}
Val=matrix(NA,5,6)
colnames(Val)=c("R_VIC","%BIAS_VIC","R_80_VIC","R_BHM","%BIAS_BHM","R_80_BHM")
rownames(Val)=data1$info$name
nam=c("g","m","h","ho","s")
for (j in 1:5) {
  indnn=which(stan_data$covQ[,j]>stan_data$thrQ[j])
  Val[j,1]=round(cor.test(datavic[,j+3],data[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
  Val[j,2]=round((mean(datavic[,j+3],na.rm=T)-mean(data[,j+3],na.rm=T))/mean(data[,j+3],na.rm=T)*100,2)
  Val[j,3]=round(cor.test(datavic[stan_data$ind_o[indnn],j+3],data[stan_data$ind_o[indnn],j+3],na.action("na.omit"),method="pearson")$estimate,2)
  tmp=apply(Simul$y_rep[,,j],2,mean)
  Val[j,4]=round(cor.test(tmp,data[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
  Val[j,5]=round((mean(tmp,na.rm=T)-mean(data[,j+3],na.rm=T))/mean(data[,j+3],na.rm=T)*100,2)
  Val[j,6]=round(cor.test(tmp[stan_data$ind_o[indnn]],data[stan_data$ind_o[indnn],j+3],na.action("na.omit"),method="pearson")$estimate,2)
}
print(Val)
```
```{r}
print(c(val1[3,1],Val[,6],Val[,4]))

print(c(Val[,3],Val[,1]))
```


**Times series garudeshwar**


```{r, fig.height=5, fig.width=10,echo=FALSE}
ptm = proc.time()
ind_t1=which(data$Year>=2013 & data$Year<=2014)
j=1
aa=paste(data$DAY,data$MONTH,data$Year,sep="/")
dat=as.Date(aa, format = "%d/%m/%Y")
par(mfrow=c(1,1))
par(mar = c(2, 3.2, 2, 0.2))
zz=boxplot(split(t(Simul$y_rep[,,j]),dat),plot=F,cex=1.0,range=2)
zz$names=rep("",length(zz$names))
limp2=c(0,max(range(zz$stats,data[,j+3],na.rm = T))*2)
tmp=apply(Simul$y_rep[,,j],2,mean)#zz$stats[3,]
z1=bxp(zz,ylim=limp2,xlim=c(20,724),xlab="",ylab="",cex=1.3,outline=FALSE,notch = FALSE,whiskcol="gray",boxcol="gray",medcol="gray",show.names=FALSE,cex.axis=1.1,cex.lab=1.1,axes=FALSE,ann=FALSE)

n1=seq(1978,2014,2)
z2=1:length(n1)
for (i in 1:length(n1)) {
 z2[i]=which(data$Year==n1[i])[1]
}
n1=as.character(n1)
axis(1,at=z2,labels=n1,cex.axis=1.1, tck = -0.02,mgp=c(0, 0.5, 0))
axis(2,cex=1.00,las=1, tck = -0.02,mgp=c(0, 0.5, 0))
# mtext("Time", side = 1, line = 1.5, cex = 1.1,font = 1)
mtext(bquote("Streamflow,"~Q(t) ~"("*10^3*m^3*s^-1*")"), side = 2, line = 1.7, cex = 1.1,font = 1)
lines(z1,data[,j+3],lty=1,lwd=2,col="red")
lines(z1,tmp,lty=2,lwd=2,col="#0b5394")

rect(ind_t1[1], -0.5, ind_t1[length(ind_t1)], limp2[2]*0.51)
abline(h=0,lty=1)
box()
mtext("(a)", side = 3, line = 0.5, cex = 1.5,font=1)
legend("topleft", legend=c("Observed","Ensembles mean","Ensembles"),lty=c(1,2,2),col = c("red","#0b5394","gray"),cex=1,lwd=c(2,2,2),inset=c(0,0), xpd=TRUE, horiz=F, bty="n")

## Here's the bit I added.
par(fig = c(grconvertX(c(550, 739), from="user", to="ndc"),
            grconvertY(c(limp2[2]*0.5, limp2[2]*1.03), from="user", to="ndc")),
    mar = c(3,3,0.3,0.3),
    new = TRUE)
    limp=c(0,60)
    plot(tmp,data[,j+3],type="p",pch = 21, bg = "lightgray", col = "black",lwd = 0.9, cex = 0.9,xlab="Ensembles median",ylab="Observed",axes=FALSE,ann=FALSE,xlim=limp,ylim=limp,cex.axis=0.9,cex.lab=0.9)
    abline(0,1)
    n2=seq(0,limp[2],10)
    axis(2,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.05,mgp=c(0, 0.3, 0))
    axis(1,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.05,mgp=c(0, 0.3, 0))
    bias_t=round((mean(tmp,na.rm=T)-mean(data[,j+3],na.rm=T))/mean(data[,j+3],na.rm=T),2)
    # bias_t=paste(bias_t,"0",sep="")
    
    temp=round(cor.test(tmp,data[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
    mtext("Observed", side = 2, line = 1, cex = 0.8,font = 1)
    mtext("Ensembles mean", side = 1, line = 1, cex = 0.8,font = 1)
    text(x=limp[2]*0.53, y=limp[2]*0.24, labels=bquote(~ R == .(temp)), pos=4, col="gray10",cex=0.8)
    text(x=limp[2]*0.32, y=limp[2]*0.06, labels=bquote(~ BIAS == .(bias_t)), pos=4, col="gray10",cex=0.8)
    # mtext(bquote(~ R^2 == .(temp)), side = 3, line = 1.8, cex =0.9,font=4)


p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg(paste("Ts_",colnames(data)[j+3],".jpg",sep=""), width = 10, height = 5, units = 'in', res = 300)
p1.base
dev.off()
# Display the saved plots
p1.base 
time_elapsed=time_elapsed+(proc.time() - ptm)[3]
```

```{r, fig.height=5, fig.width=10,echo=FALSE}
ptm = proc.time()
par(mfrow=c(1,1))
par(mar = c(5, 3.2, 2, 0.2))
ind_t1=which(data$Year>=2013 & data$Year<=2014)
plot1=Simul$y_rep[,ind_t1,j]
data1=data[ind_t1,]
aa=paste(data1$DAY,data1$MONTH,data1$Year,sep="/")
dat=as.Date(aa, format = "%d/%m/%Y")
zz=boxplot(split(t(plot1),dat),plot=F,cex=1.0,range=2)
zz$names=rep("",length(zz$names))
tmp=apply(plot1,2,mean)
z1=bxp(zz,ylim=range(zz$stats,data1[,j+3]),xlim=c(4,120),xlab="",ylab="",cex=1.3,outline=FALSE,notch = FALSE,whiskcol="gray",boxcol="gray",medcol="gray50",show.names=FALSE,cex.axis=1.1,cex.lab=1.1,axes=FALSE,ann=FALSE)

n1=c()
for (i in 1:length(ind_t1)) {
 n1=c(n1,paste(data1$MONTH[i],data1$DAY[i],data1$Year[i],sep="-"))
}
axis(1,at=z1[seq(1,124,5)],labels=n1[seq(1,124,5)],cex.axis=1.1,las=2, tck = -0.02,mgp=c(0, 0.5, 0))
axis(2,cex=1.00,las=1, tck = -0.02,mgp=c(0, 0.5, 0))
# mtext("Time", side = 1, line = 5.2, cex = 1.1,font = 1)
mtext(bquote("Streamflow,"~Q(t) ~"("*10^3*m^3*s^-1*")"), side = 2, line = 1.7, cex = 1.1,font = 1)
lines(z1,data1[,j+3],lty=1,lwd=2,col="red")
lines(z1,tmp,lty=2,lwd=2,col="#0b5394")
lines(z1,datavic[ind_t1,j+3],lty=1,lwd=2,col="#A87400")
abline(h=0,lty=1)
box()
mtext("(b)", side = 3, line = 0.5, cex = 1.5,font=1)
legend("topleft", legend=c("Observed","VIC","Ensembles mean","Ensembles"),lty=c(1,1,2,2),col = c("red","#A87400","#0b5394","gray"),cex=1,lwd=c(2,2,2,2),inset=c(0,0), xpd=TRUE, horiz=F, bty="n")

## Here's the bit I added.
par(fig = c(grconvertX(c(103, 124), from="user", to="ndc"),
            grconvertY(c(range(zz$stats,data1[,j+3])[2]*0.65, range(zz$stats,data1[,j+3])[2]*1.07), from="user", to="ndc")),
    mar = c(0.5,0.5,1,0.3),
    new = TRUE)
    limp=c(0,50)
    plot(tmp,data1[,j+3],type="p",pch = 21, bg = "lightgray", col = "black",lwd = 0.9, cex = 0.9,xlab="Ensembles median ",ylab="Observed ",axes=FALSE,ann=FALSE,xlim=limp,ylim=limp,cex.axis=0.9,cex.lab=0.9)
    abline(0,1)
    n2=seq(0,limp[2],10)
    axis(2,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.07,mgp=c(0, 0.3, 0))
    axis(1,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.07,mgp=c(0, 0.3, 0))
    bias_t=round((mean(tmp,na.rm=T)-mean(data1[,j+3],na.rm=T))/mean(data1[,j+3],na.rm=T),2)
    # bias_t=paste(bias_t,"0",sep="")
    
    temp=round(cor.test(tmp,data1[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
    mtext("Observed", side = 2, line = 1, cex = 0.8,font = 1)
    mtext("Ensembles mean", side = 1, line = 1, cex = 0.8,font = 1)
    text(x=limp[2]*0.53, y=limp[2]*0.24, labels=bquote(~ R == .(temp)), pos=4, col="gray10",cex=0.8)
    text(x=limp[2]*0.32, y=limp[2]*0.06, labels=bquote(~ BIAS == .(bias_t)), pos=4, col="gray10",cex=0.8)
    # mtext(bquote(~ R^2 == .(temp)), side = 3, line = 1.8, cex =0.9,font=4)
p1.base <- recordPlot()
invisible(dev.off())


#save the figure
setwd(dir_JPG)
jpeg(paste("Ts_",colnames(data)[j+3],"_2.jpg",sep=""), width = 10, height = 5, units = 'in', res = 300)
p1.base
dev.off()

grid::grid.newpage()
p1.base 
time_elapsed=time_elapsed+(proc.time() - ptm)[3]
```

**Times series Mandleshwar**


```{r, fig.height=5, fig.width=10,echo=FALSE}
ptm = proc.time()
ind_t1=which(data$Year>=2013 & data$Year<=2014)
j=2
aa=paste(data$DAY,data$MONTH,data$Year,sep="/")
dat=as.Date(aa, format = "%d/%m/%Y")
par(mfrow=c(1,1))
par(mar = c(2, 3.2, 2, 0.2))
zz=boxplot(split(t(Simul$y_rep[,,j]),dat),plot=F,cex=1.0,range=2)
zz$names=rep("",length(zz$names))
limp2=c(0,max(range(zz$stats,data[,j+3],na.rm = T))*2)
tmp=apply(Simul$y_rep[,,j],2,mean)#zz$stats[3,]
z1=bxp(zz,ylim=limp2,xlim=c(20,724),xlab="",ylab="",cex=1.3,outline=FALSE,notch = FALSE,whiskcol="gray",boxcol="gray",medcol="gray",show.names=FALSE,cex.axis=1.1,cex.lab=1.1,axes=FALSE,ann=FALSE)

n1=seq(1978,2014,2)
z2=1:length(n1)
for (i in 1:length(n1)) {
 z2[i]=which(data$Year==n1[i])[1]
}
n1=as.character(n1)
axis(1,at=z2,labels=n1,cex.axis=1.1, tck = -0.02,mgp=c(0, 0.5, 0))
axis(2,cex=1.00,las=1, tck = -0.02,mgp=c(0, 0.5, 0))
# mtext("Time", side = 1, line = 1.5, cex = 1.1,font = 1)
mtext(bquote("Streamflow,"~Q(t) ~"("*10^3*m^3*s^-1*")"), side = 2, line = 1.7, cex = 1.1,font = 1)
lines(z1,data[,j+3],lty=1,lwd=2,col="red")
lines(z1,tmp,lty=2,lwd=2,col="#0b5394")
rect(ind_t1[1], -0.5, ind_t1[length(ind_t1)], limp2[2]*0.51)
abline(h=0,lty=1)
box()
mtext("(a)", side = 3, line = 0.5, cex = 1.5,font=1)
legend("topleft", legend=c("Observed","Ensembles mean","Ensembles"),lty=c(1,2,2),col = c("red","#0b5394","gray"),cex=1,lwd=c(2,2,2),inset=c(0,0), xpd=TRUE, horiz=F, bty="n")

## Here's the bit I added.
par(fig = c(grconvertX(c(550, 739), from="user", to="ndc"),
            grconvertY(c(limp2[2]*0.5, limp2[2]*1.03), from="user", to="ndc")),
    mar = c(3,3,0.3,0.3),
    new = TRUE)
    limp=c(0,50)
    plot(tmp,data[,j+3],type="p",pch = 21, bg = "lightgray", col = "black",lwd = 0.9, cex = 0.9,xlab="Ensembles median",ylab="Observed",axes=FALSE,ann=FALSE,xlim=limp,ylim=limp,cex.axis=0.9,cex.lab=0.9)
    abline(0,1)
    n2=seq(0,limp[2],10)
    axis(2,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.05,mgp=c(0, 0.3, 0))
    axis(1,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.05,mgp=c(0, 0.3, 0))
    bias_t=round((mean(tmp,na.rm=T)-mean(data[,j+3],na.rm=T))/mean(data[,j+3],na.rm=T),2)
    # bias_t=paste(bias_t,"0",sep="")
    
    temp=round(cor.test(tmp,data[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
    mtext("Observed", side = 2, line = 1, cex = 0.8,font = 1)
    mtext("Ensembles mean", side = 1, line = 1, cex = 0.8,font = 1)
    text(x=limp[2]*0.53, y=limp[2]*0.24, labels=bquote(~ R == .(temp)), pos=4, col="gray10",cex=0.8)
    text(x=limp[2]*0.32, y=limp[2]*0.06, labels=bquote(~ BIAS == .(bias_t)), pos=4, col="gray10",cex=0.8)
    # mtext(bquote(~ R^2 == .(temp)), side = 3, line = 1.8, cex =0.9,font=4)


p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg(paste("Ts_",colnames(data)[j+3],".jpg",sep=""), width = 10, height = 5, units = 'in', res = 300)
p1.base
dev.off()
# Display the saved plots
p1.base 
time_elapsed=time_elapsed+(proc.time() - ptm)[3]
```

```{r, fig.height=5, fig.width=10,echo=FALSE}
ptm = proc.time()
par(mfrow=c(1,1))
par(mar = c(5, 3.2, 2, 0.2))
ind_t1=which(data$Year>=2013 & data$Year<=2014)
plot1=Simul$y_rep[,ind_t1,j]
data1=data[ind_t1,]
aa=paste(data1$DAY,data1$MONTH,data1$Year,sep="/")
dat=as.Date(aa, format = "%d/%m/%Y")
zz=boxplot(split(t(plot1),dat),plot=F,cex=1.0,range=2)
zz$names=rep("",length(zz$names))
tmp=apply(plot1,2,mean)
z1=bxp(zz,ylim=range(zz$stats,data1[,j+3]),xlim=c(4,120),xlab="",ylab="",cex=1.3,outline=FALSE,notch = FALSE,whiskcol="gray",boxcol="gray",medcol="gray50",show.names=FALSE,cex.axis=1.1,cex.lab=1.1,axes=FALSE,ann=FALSE)

n1=c()
for (i in 1:length(ind_t1)) {
 n1=c(n1,paste(data1$MONTH[i],data1$DAY[i],data1$Year[i],sep="-"))
}
axis(1,at=z1[seq(1,124,5)],labels=n1[seq(1,124,5)],cex.axis=1.1,las=2, tck = -0.02,mgp=c(0, 0.5, 0))
axis(2,cex=1.00,las=1, tck = -0.02,mgp=c(0, 0.5, 0))
# mtext("Time", side = 1, line = 5.2, cex = 1.1,font = 1)
mtext(bquote("Streamflow,"~Q(t) ~"("*10^3*m^3*s^-1*")"), side = 2, line = 1.7, cex = 1.1,font = 1)
lines(z1,data1[,j+3],lty=1,lwd=2,col="red")
lines(z1,tmp,lty=2,lwd=2,col="#0b5394")
lines(z1,datavic[ind_t1,j+3],lty=1,lwd=2,col="#A87400")
abline(h=0,lty=1)
box()
mtext("(b)", side = 3, line = 0.5, cex = 1.5,font=1)
legend("topleft", legend=c("Observed","VIC","Ensembles mean","Ensembles"),lty=c(1,1,2,2),col = c("red","#A87400","#0b5394","gray"),cex=1,lwd=c(2,2,2,2),inset=c(0,0), xpd=TRUE, horiz=F, bty="n")

## Here's the bit I added.
par(fig = c(grconvertX(c(103, 124), from="user", to="ndc"),
            grconvertY(c(range(zz$stats,data1[,j+3])[2]*0.65, range(zz$stats,data1[,j+3])[2]*1.07), from="user", to="ndc")),
    mar = c(0.5,0.5,1,0.3),
    new = TRUE)
    limp=c(0,50)
    plot(tmp,data1[,j+3],type="p",pch = 21, bg = "lightgray", col = "black",lwd = 0.9, cex = 0.9,xlab="Ensembles median ",ylab="Observed ",axes=FALSE,ann=FALSE,xlim=limp,ylim=limp,cex.axis=0.9,cex.lab=0.9)
    abline(0,1)
    n2=seq(0,limp[2],10)
    axis(2,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.07,mgp=c(0, 0.3, 0))
    axis(1,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.07,mgp=c(0, 0.3, 0))
    bias_t=round((mean(tmp)-mean(data1[,j+3]))/mean(data1[,j+3]),2)
    # bias_t=paste(bias_t,"0",sep="")
    
    temp=round(cor.test(tmp,data1[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
    mtext("Observed", side = 2, line = 1, cex = 0.8,font = 1)
    mtext("Ensembles mean", side = 1, line = 1, cex = 0.8,font = 1)
    text(x=limp[2]*0.53, y=limp[2]*0.24, labels=bquote(~ R == .(temp)), pos=4, col="gray10",cex=0.8)
    text(x=limp[2]*0.32, y=limp[2]*0.06, labels=bquote(~ BIAS == .(bias_t)), pos=4, col="gray10",cex=0.8)
    # mtext(bquote(~ R^2 == .(temp)), side = 3, line = 1.8, cex =0.9,font=4)
p1.base <- recordPlot()
invisible(dev.off())


#save the figure
setwd(dir_JPG)
jpeg(paste("Ts_",colnames(data)[j+3],"_2.jpg",sep=""), width = 10, height = 5, units = 'in', res = 300)
p1.base
dev.off()

grid::grid.newpage()
p1.base 
time_elapsed=time_elapsed+(proc.time() - ptm)[3]
```


**Times series Handia**

```{r, fig.height=5, fig.width=10,echo=FALSE}
ptm = proc.time()
ind_t1=which(data$Year>=2013 & data$Year<=2014)
j=3
aa=paste(data$DAY,data$MONTH,data$Year,sep="/")
dat=as.Date(aa, format = "%d/%m/%Y")
par(mfrow=c(1,1))
par(mar = c(2, 3.2, 2, 0.2))
zz=boxplot(split(t(Simul$y_rep[,,j]),dat),plot=F,cex=1.0,range=2)
zz$names=rep("",length(zz$names))
limp2=c(0,max(range(zz$stats,data[,j+3],na.rm = T))*2)
tmp=apply(Simul$y_rep[,,j],2,mean)#zz$stats[3,]
z1=bxp(zz,ylim=limp2,xlim=c(20,724),xlab="",ylab="",cex=1.3,outline=FALSE,notch = FALSE,whiskcol="gray",boxcol="gray",medcol="gray",show.names=FALSE,cex.axis=1.1,cex.lab=1.1,axes=FALSE,ann=FALSE)

n1=seq(1978,2014,2)
z2=1:length(n1)
for (i in 1:length(n1)) {
 z2[i]=which(data$Year==n1[i])[1]
}
n1=as.character(n1)
axis(1,at=z2,labels=n1,cex.axis=1.1, tck = -0.02,mgp=c(0, 0.5, 0))
axis(2,cex=1.00,las=1, tck = -0.02,mgp=c(0, 0.5, 0))
# mtext("Time", side = 1, line = 1.5, cex = 1.1,font = 1)
mtext(bquote("Streamflow,"~Q(t) ~"("*10^3*m^3*s^-1*")"), side = 2, line = 1.7, cex = 1.1,font = 1)
lines(z1,data[,j+3],lty=1,lwd=2,col="red")
lines(z1,tmp,lty=2,lwd=2,col="#0b5394")
rect(ind_t1[1], -0.5, ind_t1[length(ind_t1)], limp2[2]*0.51)
abline(h=0,lty=1)
box()
mtext("(a)", side = 3, line = 0.5, cex = 1.5,font=1)
legend("topleft", legend=c("Observed","Ensembles mean","Ensembles"),lty=c(1,2,2),col = c("red","#0b5394","gray"),cex=1,lwd=c(2,2,2),inset=c(0,0), xpd=TRUE, horiz=F, bty="n")

## Here's the bit I added.
par(fig = c(grconvertX(c(550, 739), from="user", to="ndc"),
            grconvertY(c(limp2[2]*0.5, limp2[2]*1.03), from="user", to="ndc")),
    mar = c(3,3,0.3,0.3),
    new = TRUE)
    limp=c(0,40)
    plot(tmp,data[,j+3],type="p",pch = 21, bg = "lightgray", col = "black",lwd = 0.9, cex = 0.9,xlab="Ensembles median",ylab="Observed",axes=FALSE,ann=FALSE,xlim=limp,ylim=limp,cex.axis=0.9,cex.lab=0.9)
    abline(0,1)
    n2=seq(0,limp[2],10)
    axis(2,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.05,mgp=c(0, 0.3, 0))
    axis(1,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.05,mgp=c(0, 0.3, 0))
    bias_t=round((mean(tmp,na.rm=T)-mean(data[,j+3],na.rm=T))/mean(data[,j+3],na.rm=T),2)
    # bias_t=paste(bias_t,"0",sep="")
    
    temp=round(cor.test(tmp,data[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
    mtext("Observed", side = 2, line = 1, cex = 0.8,font = 1)
    mtext("Ensembles mean", side = 1, line = 1, cex = 0.8,font = 1)
    text(x=limp[2]*0.53, y=limp[2]*0.24, labels=bquote(~ R == .(temp)), pos=4, col="gray10",cex=0.8)
    text(x=limp[2]*0.32, y=limp[2]*0.06, labels=bquote(~ BIAS == .(bias_t)), pos=4, col="gray10",cex=0.8)
    # mtext(bquote(~ R^2 == .(temp)), side = 3, line = 1.8, cex =0.9,font=4)


p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg(paste("Ts_",colnames(data)[j+3],".jpg",sep=""), width = 10, height = 5, units = 'in', res = 300)
p1.base
dev.off()
# Display the saved plots
p1.base 
time_elapsed=time_elapsed+(proc.time() - ptm)[3]
```

```{r, fig.height=5, fig.width=10,echo=FALSE}
ptm = proc.time()
par(mfrow=c(1,1))
par(mar = c(5, 3.2, 2, 0.2))
ind_t1=which(data$Year>=2013 & data$Year<=2014)
plot1=Simul$y_rep[,ind_t1,j]
data1=data[ind_t1,]
aa=paste(data1$DAY,data1$MONTH,data1$Year,sep="/")
dat=as.Date(aa, format = "%d/%m/%Y")
zz=boxplot(split(t(plot1),dat),plot=F,cex=1.0,range=2)
zz$names=rep("",length(zz$names))
tmp=apply(plot1,2,mean)
z1=bxp(zz,ylim=range(zz$stats,data1[,j+3]),xlim=c(4,120),xlab="",ylab="",cex=1.3,outline=FALSE,notch = FALSE,whiskcol="gray",boxcol="gray",medcol="gray50",show.names=FALSE,cex.axis=1.1,cex.lab=1.1,axes=FALSE,ann=FALSE)

n1=c()
for (i in 1:length(ind_t1)) {
 n1=c(n1,paste(data1$MONTH[i],data1$DAY[i],data1$Year[i],sep="-"))
}
axis(1,at=z1[seq(1,124,5)],labels=n1[seq(1,124,5)],cex.axis=1.1,las=2, tck = -0.02,mgp=c(0, 0.5, 0))
axis(2,cex=1.00,las=1, tck = -0.02,mgp=c(0, 0.5, 0))
# mtext("Time", side = 1, line = 5.2, cex = 1.1,font = 1)
mtext(bquote("Streamflow,"~Q(t) ~"("*10^3*m^3*s^-1*")"), side = 2, line = 1.7, cex = 1.1,font = 1)
lines(z1,data1[,j+3],lty=1,lwd=2,col="red")
lines(z1,tmp,lty=2,lwd=2,col="#0b5394")
lines(z1,datavic[ind_t1,j+3],lty=1,lwd=2,col="#A87400")
abline(h=0,lty=1)
box()
mtext("(b)", side = 3, line = 0.5, cex = 1.5,font=1)
legend("topleft", legend=c("Observed","VIC","Ensembles mean","Ensembles"),lty=c(1,1,2,2),col = c("red","#A87400","#0b5394","gray"),cex=1,lwd=c(2,2,2,2),inset=c(0,0), xpd=TRUE, horiz=F, bty="n")

## Here's the bit I added.
par(fig = c(grconvertX(c(103, 124), from="user", to="ndc"),
            grconvertY(c(range(zz$stats,data1[,j+3])[2]*0.65, range(zz$stats,data1[,j+3])[2]*1.07), from="user", to="ndc")),
    mar = c(0.5,0.5,1,0.3),
    new = TRUE)
    limp=c(0,40)
    plot(tmp,data1[,j+3],type="p",pch = 21, bg = "lightgray", col = "black",lwd = 0.9, cex = 0.9,xlab="Ensembles median ",ylab="Observed ",axes=FALSE,ann=FALSE,xlim=limp,ylim=limp,cex.axis=0.9,cex.lab=0.9)
    abline(0,1)
    n2=seq(0,limp[2],10)
    axis(2,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.07,mgp=c(0, 0.3, 0))
    axis(1,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.07,mgp=c(0, 0.3, 0))
    bias_t=round((mean(tmp)-mean(data1[,j+3]))/mean(data1[,j+3]),2)
    # bias_t=paste(bias_t,"0",sep="")
    
    temp=round(cor.test(tmp,data1[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
    mtext("Observed", side = 2, line = 1, cex = 0.8,font = 1)
    mtext("Ensembles mean", side = 1, line = 1, cex = 0.8,font = 1)
    text(x=limp[2]*0.53, y=limp[2]*0.24, labels=bquote(~ R == .(temp)), pos=4, col="gray10",cex=0.8)
    text(x=limp[2]*0.32, y=limp[2]*0.06, labels=bquote(~ BIAS == .(bias_t)), pos=4, col="gray10",cex=0.8)
    # mtext(bquote(~ R^2 == .(temp)), side = 3, line = 1.8, cex =0.9,font=4)
p1.base <- recordPlot()
invisible(dev.off())


#save the figure
setwd(dir_JPG)
jpeg(paste("Ts_",colnames(data)[j+3],"_2.jpg",sep=""), width = 10, height = 5, units = 'in', res = 300)
p1.base
dev.off()

grid::grid.newpage()
p1.base 
time_elapsed=time_elapsed+(proc.time() - ptm)[3]
```


**Times series Hoshangabad**

```{r, fig.height=5, fig.width=10,echo=FALSE}
ptm = proc.time()
ind_t1=which(data$Year>=2013 & data$Year<=2014)
j=4
aa=paste(data$DAY,data$MONTH,data$Year,sep="/")
dat=as.Date(aa, format = "%d/%m/%Y")
par(mfrow=c(1,1))
par(mar = c(2, 3.2, 2, 0.2))
zz=boxplot(split(t(Simul$y_rep[,,j]),dat),plot=F,cex=1.0,range=2)
zz$names=rep("",length(zz$names))
limp2=c(0,max(range(zz$stats,data[,j+3],na.rm = T))*2)
tmp=apply(Simul$y_rep[,,j],2,mean)#zz$stats[3,]
z1=bxp(zz,ylim=limp2,xlim=c(20,724),xlab="",ylab="",cex=1.3,outline=FALSE,notch = FALSE,whiskcol="gray",boxcol="gray",medcol="gray",show.names=FALSE,cex.axis=1.1,cex.lab=1.1,axes=FALSE,ann=FALSE)

n1=seq(1978,2014,2)
z2=1:length(n1)
for (i in 1:length(n1)) {
 z2[i]=which(data$Year==n1[i])[1]
}
n1=as.character(n1)
axis(1,at=z2,labels=n1,cex.axis=1.1, tck = -0.02,mgp=c(0, 0.5, 0))
axis(2,cex=1.00,las=1, tck = -0.02,mgp=c(0, 0.5, 0))
# mtext("Time", side = 1, line = 1.5, cex = 1.1,font = 1)
mtext(bquote("Streamflow,"~Q(t) ~"("*10^3*m^3*s^-1*")"), side = 2, line = 1.7, cex = 1.1,font = 1)
lines(z1,data[,j+3],lty=1,lwd=2,col="red")
lines(z1,tmp,lty=2,lwd=2,col="#0b5394")
rect(ind_t1[1], -0.5, ind_t1[length(ind_t1)], limp2[2]*0.51)
abline(h=0,lty=1)
box()
mtext("(a)", side = 3, line = 0.5, cex = 1.5,font=1)
legend("topleft", legend=c("Observed","Ensembles mean","Ensembles"),lty=c(1,2,2),col = c("red","#0b5394","gray"),cex=1,lwd=c(2,2,2),inset=c(0,0), xpd=TRUE, horiz=F, bty="n")

## Here's the bit I added.
par(fig = c(grconvertX(c(550, 739), from="user", to="ndc"),
            grconvertY(c(limp2[2]*0.5, limp2[2]*1.03), from="user", to="ndc")),
    mar = c(3,3,0.3,0.3),
    new = TRUE)
    limp=c(0,40)
    plot(tmp,data[,j+3],type="p",pch = 21, bg = "lightgray", col = "black",lwd = 0.9, cex = 0.9,xlab="Ensembles median",ylab="Observed",axes=FALSE,ann=FALSE,xlim=limp,ylim=limp,cex.axis=0.9,cex.lab=0.9)
    abline(0,1)
    n2=seq(0,limp[2],10)
    axis(2,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.05,mgp=c(0, 0.3, 0))
    axis(1,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.05,mgp=c(0, 0.3, 0))
    bias_t=round((mean(tmp,na.rm=T)-mean(data[,j+3],na.rm=T))/mean(data[,j+3],na.rm=T),2)
    # bias_t=paste(bias_t,"0",sep="")
    
    temp=round(cor.test(tmp,data[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
    mtext("Observed", side = 2, line = 1, cex = 0.8,font = 1)
    mtext("Ensembles mean", side = 1, line = 1, cex = 0.8,font = 1)
    text(x=limp[2]*0.53, y=limp[2]*0.24, labels=bquote(~ R == .(temp)), pos=4, col="gray10",cex=0.8)
    text(x=limp[2]*0.32, y=limp[2]*0.06, labels=bquote(~ BIAS == .(bias_t)), pos=4, col="gray10",cex=0.8)
    # mtext(bquote(~ R^2 == .(temp)), side = 3, line = 1.8, cex =0.9,font=4)


p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg(paste("Ts_",colnames(data)[j+3],".jpg",sep=""), width = 10, height = 5, units = 'in', res = 300)
p1.base
dev.off()
# Display the saved plots
p1.base 
time_elapsed=time_elapsed+(proc.time() - ptm)[3]
```

```{r, fig.height=5, fig.width=10,echo=FALSE}
ptm = proc.time()
par(mfrow=c(1,1))
par(mar = c(5, 3.2, 2, 0.2))
ind_t1=which(data$Year>=2013 & data$Year<=2014)
plot1=Simul$y_rep[,ind_t1,j]
data1=data[ind_t1,]
aa=paste(data1$DAY,data1$MONTH,data1$Year,sep="/")
dat=as.Date(aa, format = "%d/%m/%Y")
zz=boxplot(split(t(plot1),dat),plot=F,cex=1.0,range=2)
zz$names=rep("",length(zz$names))
tmp=apply(plot1,2,mean)
z1=bxp(zz,ylim=range(zz$stats,data1[,j+3]),xlim=c(4,120),xlab="",ylab="",cex=1.3,outline=FALSE,notch = FALSE,whiskcol="gray",boxcol="gray",medcol="gray50",show.names=FALSE,cex.axis=1.1,cex.lab=1.1,axes=FALSE,ann=FALSE)

n1=c()
for (i in 1:length(ind_t1)) {
 n1=c(n1,paste(data1$MONTH[i],data1$DAY[i],data1$Year[i],sep="-"))
}
axis(1,at=z1[seq(1,124,5)],labels=n1[seq(1,124,5)],cex.axis=1.1,las=2, tck = -0.02,mgp=c(0, 0.5, 0))
axis(2,cex=1.00,las=1, tck = -0.02,mgp=c(0, 0.5, 0))
# mtext("Time", side = 1, line = 5.2, cex = 1.1,font = 1)
mtext(bquote("Streamflow,"~Q(t) ~"("*10^3*m^3*s^-1*")"), side = 2, line = 1.7, cex = 1.1,font = 1)
lines(z1,data1[,j+3],lty=1,lwd=2,col="red")
lines(z1,tmp,lty=2,lwd=2,col="#0b5394")
lines(z1,datavic[ind_t1,j+3],lty=1,lwd=2,col="#A87400")
abline(h=0,lty=1)
box()
mtext("(b)", side = 3, line = 0.5, cex = 1.5,font=1)
legend("topleft", legend=c("Observed","VIC","Ensembles mean","Ensembles"),lty=c(1,1,2,2),col = c("red","#A87400","#0b5394","gray"),cex=1,lwd=c(2,2,2,2),inset=c(0,0), xpd=TRUE, horiz=F, bty="n")

## Here's the bit I added.
par(fig = c(grconvertX(c(103, 124), from="user", to="ndc"),
            grconvertY(c(range(zz$stats,data1[,j+3])[2]*0.65, range(zz$stats,data1[,j+3])[2]*1.07), from="user", to="ndc")),
    mar = c(0.5,0.5,1,0.3),
    new = TRUE)
    limp=c(0,30)
    plot(tmp,data1[,j+3],type="p",pch = 21, bg = "lightgray", col = "black",lwd = 0.9, cex = 0.9,xlab="Ensembles median ",ylab="Observed ",axes=FALSE,ann=FALSE,xlim=limp,ylim=limp,cex.axis=0.9,cex.lab=0.9)
    abline(0,1)
    n2=seq(0,limp[2],10)
    axis(2,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.07,mgp=c(0, 0.3, 0))
    axis(1,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.07,mgp=c(0, 0.3, 0))
    bias_t=round((mean(tmp)-mean(data1[,j+3]))/mean(data1[,j+3]),2)
    # bias_t=paste(bias_t,"0",sep="")
    
    temp=round(cor.test(tmp,data1[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
    mtext("Observed", side = 2, line = 1, cex = 0.8,font = 1)
    mtext("Ensembles mean", side = 1, line = 1, cex = 0.8,font = 1)
    text(x=limp[2]*0.53, y=limp[2]*0.24, labels=bquote(~ R == .(temp)), pos=4, col="gray10",cex=0.8)
    text(x=limp[2]*0.32, y=limp[2]*0.06, labels=bquote(~ BIAS == .(bias_t)), pos=4, col="gray10",cex=0.8)
    # mtext(bquote(~ R^2 == .(temp)), side = 3, line = 1.8, cex =0.9,font=4)
p1.base <- recordPlot()
invisible(dev.off())


#save the figure
setwd(dir_JPG)
jpeg(paste("Ts_",colnames(data)[j+3],"_2.jpg",sep=""), width = 10, height = 5, units = 'in', res = 300)
p1.base
dev.off()

grid::grid.newpage()
p1.base 
time_elapsed=time_elapsed+(proc.time() - ptm)[3]
```


**Times series Sandiya**

```{r, fig.height=5, fig.width=10,echo=FALSE}
ptm = proc.time()
ind_t1=which(data$Year>=2013 & data$Year<=2014)
j=5
aa=paste(data$DAY,data$MONTH,data$Year,sep="/")
dat=as.Date(aa, format = "%d/%m/%Y")
par(mfrow=c(1,1))
par(mar = c(2, 3.2, 2, 0.2))
zz=boxplot(split(t(Simul$y_rep[,,j]),dat),plot=F,cex=1.0,range=2)
zz$names=rep("",length(zz$names))
limp2=c(0,max(range(zz$stats,data[,j+3],na.rm = T))*2)
tmp=apply(Simul$y_rep[,,j],2,mean)#zz$stats[3,]
z1=bxp(zz,ylim=limp2,xlim=c(20,724),xlab="",ylab="",cex=1.3,outline=FALSE,notch = FALSE,whiskcol="gray",boxcol="gray",medcol="gray",show.names=FALSE,cex.axis=1.1,cex.lab=1.1,axes=FALSE,ann=FALSE)

n1=seq(1978,2014,2)
z2=1:length(n1)
for (i in 1:length(n1)) {
 z2[i]=which(data$Year==n1[i])[1]
}
n1=as.character(n1)
axis(1,at=z2,labels=n1,cex.axis=1.1, tck = -0.02,mgp=c(0, 0.5, 0))
axis(2,cex=1.00,las=1, tck = -0.02,mgp=c(0, 0.5, 0))
# mtext("Time", side = 1, line = 1.5, cex = 1.1,font = 1)
mtext(bquote("Streamflow,"~Q(t) ~"("*10^3*m^3*s^-1*")"), side = 2, line = 1.7, cex = 1.1,font = 1)
lines(z1,data[,j+3],lty=1,lwd=2,col="red")
lines(z1,tmp,lty=2,lwd=2,col="#0b5394")
rect(ind_t1[1], -0.5, ind_t1[length(ind_t1)], limp2[2]*0.51)
abline(h=0,lty=1)
box()
mtext("(a)", side = 3, line = 0.5, cex = 1.5,font=1)
legend("topleft", legend=c("Observed","Ensembles mean","Ensembles"),lty=c(1,2,2),col = c("red","#0b5394","gray"),cex=1,lwd=c(2,2,2),inset=c(0,0), xpd=TRUE, horiz=F, bty="n")

## Here's the bit I added.
par(fig = c(grconvertX(c(550, 739), from="user", to="ndc"),
            grconvertY(c(limp2[2]*0.5, limp2[2]*1.03), from="user", to="ndc")),
    mar = c(3,3,0.3,0.3),
    new = TRUE)
    limp=c(0,40)
    plot(tmp,data[,j+3],type="p",pch = 21, bg = "lightgray", col = "black",lwd = 0.9, cex = 0.9,xlab="Ensembles median",ylab="Observed",axes=FALSE,ann=FALSE,xlim=limp,ylim=limp,cex.axis=0.9,cex.lab=0.9)
    abline(0,1)
    n2=seq(0,limp[2],10)
    axis(2,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.05,mgp=c(0, 0.3, 0))
    axis(1,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.05,mgp=c(0, 0.3, 0))
    bias_t=round((mean(tmp,na.rm=T)-mean(data[,j+3],na.rm=T))/mean(data[,j+3],na.rm=T),2)
    # bias_t=paste(bias_t,"0",sep="")
    
    temp=round(cor.test(tmp,data[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
    mtext("Observed", side = 2, line = 1, cex = 0.8,font = 1)
    mtext("Ensembles mean", side = 1, line = 1, cex = 0.8,font = 1)
    text(x=limp[2]*0.53, y=limp[2]*0.24, labels=bquote(~ R == .(temp)), pos=4, col="gray10",cex=0.8)
    text(x=limp[2]*0.32, y=limp[2]*0.06, labels=bquote(~ BIAS == .(bias_t)), pos=4, col="gray10",cex=0.8)
    # mtext(bquote(~ R^2 == .(temp)), side = 3, line = 1.8, cex =0.9,font=4)


p1.base <- recordPlot()
invisible(dev.off())
#save the figure
setwd(dir_JPG)
jpeg(paste("Ts_",colnames(data)[j+3],".jpg",sep=""), width = 10, height = 5, units = 'in', res = 300)
p1.base
dev.off()
# Display the saved plots
p1.base 
time_elapsed=time_elapsed+(proc.time() - ptm)[3]
```

```{r, fig.height=5, fig.width=10,echo=FALSE}
ptm = proc.time()
par(mfrow=c(1,1))
par(mar = c(5, 3.2, 2, 0.2))
ind_t1=which(data$Year>=2013 & data$Year<=2014)
plot1=Simul$y_rep[,ind_t1,j]
data1=data[ind_t1,]
aa=paste(data1$DAY,data1$MONTH,data1$Year,sep="/")
dat=as.Date(aa, format = "%d/%m/%Y")
zz=boxplot(split(t(plot1),dat),plot=F,cex=1.0,range=2)
zz$names=rep("",length(zz$names))
tmp=apply(plot1,2,mean)
z1=bxp(zz,ylim=range(zz$stats,data1[,j+3]),xlim=c(4,120),xlab="",ylab="",cex=1.3,outline=FALSE,notch = FALSE,whiskcol="gray",boxcol="gray",medcol="gray50",show.names=FALSE,cex.axis=1.1,cex.lab=1.1,axes=FALSE,ann=FALSE)

n1=c()
for (i in 1:length(ind_t1)) {
 n1=c(n1,paste(data1$MONTH[i],data1$DAY[i],data1$Year[i],sep="-"))
}
axis(1,at=z1[seq(1,124,5)],labels=n1[seq(1,124,5)],cex.axis=1.1,las=2, tck = -0.02,mgp=c(0, 0.5, 0))
axis(2,cex=1.00,las=1, tck = -0.02,mgp=c(0, 0.5, 0))
# mtext("Time", side = 1, line = 5.2, cex = 1.1,font = 1)
mtext(bquote("Streamflow,"~Q(t) ~"("*10^3*m^3*s^-1*")"), side = 2, line = 1.7, cex = 1.1,font = 1)
lines(z1,data1[,j+3],lty=1,lwd=2,col="red")
lines(z1,tmp,lty=2,lwd=2,col="#0b5394")
lines(z1,datavic[ind_t1,j+3],lty=1,lwd=2,col="#A87400")
abline(h=0,lty=1)
box()
mtext("(b)", side = 3, line = 0.5, cex = 1.5,font=1)
legend("topleft", legend=c("Observed","VIC","Ensembles mean","Ensembles"),lty=c(1,1,2,2),col = c("red","#A87400","#0b5394","gray"),cex=1,lwd=c(2,2,2,2),inset=c(0,0), xpd=TRUE, horiz=F, bty="n")

## Here's the bit I added.
par(fig = c(grconvertX(c(103, 124), from="user", to="ndc"),
            grconvertY(c(range(zz$stats,data1[,j+3])[2]*0.65, range(zz$stats,data1[,j+3])[2]*1.07), from="user", to="ndc")),
    mar = c(0.5,0.5,1,0.3),
    new = TRUE)
    limp=c(0,30)
    plot(tmp,data1[,j+3],type="p",pch = 21, bg = "lightgray", col = "black",lwd = 0.9, cex = 0.9,xlab="Ensembles median ",ylab="Observed ",axes=FALSE,ann=FALSE,xlim=limp,ylim=limp,cex.axis=0.9,cex.lab=0.9)
    abline(0,1)
    n2=seq(0,limp[2],10)
    axis(2,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.07,mgp=c(0, 0.3, 0))
    axis(1,labels = TRUE,at=n2,cex.axis=0.8, tck = -0.07,mgp=c(0, 0.3, 0))
    bias_t=round((mean(tmp)-mean(data1[,j+3]))/mean(data1[,j+3]),2)
    # bias_t=paste(bias_t,"0",sep="")
    
    temp=round(cor.test(tmp,data1[,j+3],na.action("na.omit"),method="pearson")$estimate,2)
    mtext("Observed", side = 2, line = 1, cex = 0.8,font = 1)
    mtext("Ensembles meann", side = 1, line = 1, cex = 0.8,font = 1)
    text(x=limp[2]*0.53, y=limp[2]*0.24, labels=bquote(~ R == .(temp)), pos=4, col="gray10",cex=0.8)
    text(x=limp[2]*0.32, y=limp[2]*0.06, labels=bquote(~ BIAS == .(bias_t)), pos=4, col="gray10",cex=0.8)
    # mtext(bquote(~ R^2 == .(temp)), side = 3, line = 1.8, cex =0.9,font=4)
p1.base <- recordPlot()
invisible(dev.off())


#save the figure
setwd(dir_JPG)
jpeg(paste("Ts_",colnames(data)[j+3],"_2.jpg",sep=""), width = 10, height = 5, units = 'in', res = 300)
p1.base
dev.off()

grid::grid.newpage()
p1.base 
time_elapsed=time_elapsed+(proc.time() - ptm)[3]
```

```{r}
sprintf("elapsed time: %s minutes",round((proc.time() - ptm1)[3]/60,2))
```


